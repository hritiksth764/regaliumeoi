<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EOI Form with Signed PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        margin: 20px;
        background: #0c0707;
      }

      @font-face {
        font-family: "Avenir Next";
        src: url("fonts/Avenir Next.ttc") format("truetype");
        font-weight: 400;
        font-style: normal;
      }

      @font-face {
        font-family: "Agentur";
        src: url("fonts/FontsFree-Net-Agentur-Regular.ttf") format("truetype");
        font-weight: 400;
        font-style: normal;
      }

      @font-face {
        font-family: "Agentur Display";
        src: url("fonts/FontsFree-Net-Agentur-Display.ttf") format("truetype");
        font-weight: 400;
        font-style: normal;
      }

      @font-face {
        font-family: "Roboto Mono";
        src: url("fonts/RobotoMono-VariableFont_wght.ttf") format("truetype");
        font-weight: 400;
        font-style: normal;
      }

      #form-container {
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
      }

      #pdf-preview {
        width: 100%;
        height: 500px;
        border: 1px solid #ccc;
        margin-bottom: 20px;
        overflow: scroll;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 15px; /* Consistent spacing between fields */
      }

      form div {
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }

      label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #111;
        font-family: "Avenir Next";
        font-size: 14px;
        font-style: normal;
        font-weight: 400;
        line-height: 140%; /* 19.6px */
      }

      h1 {
        color: #fff;
        text-align: center;
        font-family: Agentur !important;
        font-size: 50px; /* Reduced size for mobile */
        font-style: normal;
        font-weight: 400;
        line-height: 120%; /* Adjusted for smaller screens */
        letter-spacing: 2px;
        text-transform: uppercase;
      }

      p {
        color: #baaf95;
        text-align: center;
        font-family: "Work Sans";
        font-size: 16px; /* Smaller font size for readability on mobile */
        font-style: normal;
        font-weight: 400;
        line-height: 140%; /* Adjusted line height */
        letter-spacing: 2px;
      }

      input,
      textarea {
        max-width: 100%; /* Prevent input from exceeding form-container */
        width: 100%; /* Full width for mobile */
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* Includes padding and border in the width */
        color: var(--Black-60, rgba(17, 17, 19, 0.6));
        font-family: "Avenir";
        font-size: 14px;
        font-style: normal;
        font-weight: 400;
        line-height: 140%; /* 19.6px */
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px 20px;
        border-radius: 4px;
        margin-top: 10px;
        align-self: flex-start;
        border-radius: 2px;
        background: #111;
      }

      button:hover {
        background-color: #0056b3;
      }

      #signature-preview {
        font-family: "Pacifico", cursive;
        font-size: 24px;
        color: #333;
        margin-top: 10px;
      }

      a {
        color: #c14535;
        font-family: "Avenir Next";
        font-size: 14px;
        font-style: normal;
        font-weight: 700;
        line-height: 180%;
        text-decoration-line: underline;
        text-decoration-style: solid;
        text-decoration-skip-ink: none;
        text-decoration-thickness: auto;
        text-underline-offset: auto;
        text-underline-position: from-font;
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        body {
          margin: 10px; /* Reduce margin for smaller screens */
        }

        #form-container {
          padding: 15px; /* Adjust padding */
          border-radius: 4px;
        }

        #pdf-preview {
          height: 300px; /* Reduce height for mobile screens */
        }

        h1 {
          margin-top: 94px;
          margin-bottom: 0px;
          font-size: 28px; /* Further reduce heading size for mobile */
          line-height: 120%;
        }

        .heading-paragraph {
          color: #baaf95;
          text-align: center;
          font-family: "Work Sans";
          font-size: 14px;
          font-style: normal;
          font-weight: 400;
          line-height: 140%;
          letter-spacing: 3.2px;
          margin-bottom: 48px; /* Space below the first paragraph */
        }

        .subtext-paragraph {
          color: #baaf95;
          text-align: center;
          font-family: "Work Sans";
          font-size: 14px;
          font-style: normal;
          font-weight: 400;
          line-height: 140%;
          letter-spacing: 3.2px;
        }

        .need-changes {
          color: black;
          text-align: center;
          font-family: "Avenir Next";
          font-size: 12px;
          font-style: normal;
          font-weight: 400;
          line-height: 160%; /* 19.2px */
        }

        a {
          color: #c14535;
          font-family: "Avenir Next";
          font-size: 14px;
          font-style: normal;
          font-weight: 700;
          line-height: 180%;
          text-decoration-line: underline;
          text-decoration-style: solid;
          text-decoration-skip-ink: none;
          text-decoration-thickness: auto;
          text-underline-offset: auto;
          text-underline-position: from-font;
        }

        button {
          width: 100%; /* Full width buttons on mobile */
          padding: 12px; /* Slightly larger buttons */
        }
      }
    </style>
    <!-- Google Font for Signature Style -->
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>JOIN US AS REGALIUM</h1>
    <p class="heading-paragraph">A Realisation of the Future</p>
    <p class="subtext-paragraph">
      Please go through the Expression of Interest and fill out the below form.
    </p>
    <div id="form-container">
      <!-- <h1>JOIN US AS REGALIUM</h1> -->
      <!-- PDF Preview -->
      <iframe
        id="pdf-preview"
        src="/RegaliumLetterheadTemplate.pdf"
        type="application/pdf"
        style="
          width: 100%;
          height: 500px;
          border: 1px solid #ccc;
          overflow: scroll;
        "
      >
      </iframe>
      <p class="need-changes">
        If you cannot view the PDF,
        <a href="/RegaliumLetterheadTemplate.pdf" target="_blank"
          >click here to open or download it</a
        >
      </p>
      <!-- EOI Form -->
      <form id="eoi-form" onsubmit="handleSubmit(event)">
        <label for="brandName">Company Name:</label>
        <input id="brandName" name="brandName" required />

        <label for="legalEntity">Legal Entity:</label>
        <input id="legalEntity" name="legalEntity" required />

        <label for="contactPerson">Contact Person:</label>
        <input id="contactPerson" name="contactPerson" required />

        <label for="contactDetails">Contact Details(Phone):</label>
        <input id="contactDetails" name="contactDetails" required />

        <label for="category">Category of Business:</label>
        <input id="category" name="category" required />

        <label for="carpetArea"
          >Approximate Carpet Area Requirement in (Sq.Ft):</label
        >
        <input id="carpetArea" name="carpetArea" required />

        <label for="specificRequirements"
          >Any Specific Requirements or Preferences:</label
        >
        <textarea
          id="specificRequirements"
          name="specificRequirements"
        ></textarea>

        <label for="signatureName">Name (For Signature):</label>
        <input
          id="signatureName"
          name="signatureName"
          required
          oninput="generateSignature()"
        />
        <div id="signature-preview">Your signature will appear here...</div>

        <label for="designation">Designation:</label>
        <input id="designation" name="designation" required />

        <button type="submit">Submit & Download PDF</button>
      </form>
    </div>

    <script type="module">
      import fontkit from "fontkit";
      import { PDFDocument, rgb } from "pdf-lib";
      import axios from "axios"; // Ensure axios is installed in your project

      // Function to generate the signature preview
      function generateSignature() {
        const name = document.getElementById("signatureName").value;
        const signaturePreview = document.getElementById("signature-preview");
        signaturePreview.textContent =
          name.trim() !== "" ? name : "Your signature will appear here...";
      }

      // Form submission handler
      async function handleSubmit(event) {
        event.preventDefault();

        const formData = {
          brandName: document.getElementById("brandName").value,
          legalEntity: document.getElementById("legalEntity").value,
          contactPerson: document.getElementById("contactPerson").value,
          contactDetails: document.getElementById("contactDetails").value,
          category: document.getElementById("category").value,
          carpetArea: document.getElementById("carpetArea").value,
          specificRequirements: document.getElementById("specificRequirements")
            .value,
          designation: document.getElementById("designation").value,
        };

        try {
          // Save data to Google Sheets
          await saveToGoogleSheets(formData);

          alert(
            "Your data has been successfully saved! Generating your signed EOI..."
          );

          // Generate the signed PDF
          await generateSignedPDF(formData);

          // Clear the form fields after successful generation
          document.getElementById("eoi-form").reset();
          generateSignature(); // Reset the signature preview
        } catch (error) {
          console.error("Error during submission:", error);
          alert("An error occurred. Please try again.");
        }
      }

      // Function to save data to Google Sheets
      async function saveToGoogleSheets(data) {
        const sheetDBUrl = "https://sheetdb.io/api/v1/ol7be1lpzozf7"; // Replace with your SheetDB API URL

        const formattedData = {
          data: {
            "Brand Name": data.brandName,
            "Legal Entity": data.legalEntity,
            "Contact Person": data.contactPerson,
            "Contact Details": data.contactDetails,
            Category: data.category,
            "Carpet Area": data.carpetArea,
            Requirements: data.specificRequirements || "N/A",
            Designation: data.designation,
            Timestamp: new Date().toLocaleString(),
          },
        };

        try {
          const response = await axios.post(sheetDBUrl, formattedData);
          console.log("Data saved successfully:", response.data);
        } catch (error) {
          console.error("Error saving data to Google Sheets:", error);
          throw new Error("Failed to save data to Google Sheets.");
        }
      }

      // Function to generate signed PDF
      async function generateSignedPDF(formData) {
        // Register fontkit
        PDFDocument.registerFontkit(fontkit);

        // Load Avenir font
        const avenirFontBytes = await fetch(
          "/path-to-font/AvenirNext-Regular.ttf"
        ).then((res) => res.arrayBuffer());

        // Load PDF template
        const pdfBytes = await fetch("/RegaliumLetterheadTemplate.pdf").then(
          (res) => res.arrayBuffer()
        );

        // Load PDF document
        const pdfDoc = await PDFDocument.load(pdfBytes);

        // Embed Avenir font
        const avenirFont = await pdfDoc.embedFont(avenirFontBytes);

        // Add a new page
        const newPage = pdfDoc.addPage([595, 842]); // A4 size
        const { width, height } = newPage.getSize();

        const tableStartX = 50;
        let currentY = height - 50;

        // Heading: "YOUR DETAILS"
        const headingText = "YOUR DETAILS";
        const headingFontSize = 16;
        const headingWidth = avenirFont.widthOfTextAtSize(
          headingText,
          headingFontSize
        );
        const headingX = (width - headingWidth) / 2;

        newPage.drawText(headingText, {
          x: headingX,
          y: currentY,
          size: headingFontSize,
          font: avenirFont,
          color: rgb(0, 0, 0),
        });

        currentY -= 40;

        // Table Data
        const tableData = [
          ["Company Name", formData.brandName],
          ["Legal Entity", formData.legalEntity],
          ["Contact Person", formData.contactPerson],
          ["Contact Details", formData.contactDetails],
          ["Category of Business", formData.category],
          [
            "Approx. Carpet Area Requirement (Sq.Ft)",
            `${formData.carpetArea} Sq.Ft`,
          ],
          [
            "Any Specific Requirements or Preferences",
            formData.specificRequirements || "N/A",
          ],
        ];

        const rowHeight = 25;
        const colWidths = [200, 300];
        const lineThickness = 0.5;

        tableData.forEach(([label, value]) => {
          newPage.drawRectangle({
            x: tableStartX,
            y: currentY - rowHeight,
            width: colWidths[0],
            height: rowHeight,
            borderWidth: lineThickness,
            borderColor: rgb(0, 0, 0),
            color: rgb(1, 1, 1),
          });

          newPage.drawRectangle({
            x: tableStartX + colWidths[0],
            y: currentY - rowHeight,
            width: colWidths[1],
            height: rowHeight,
            borderWidth: lineThickness,
            borderColor: rgb(0, 0, 0),
            color: rgb(1, 1, 1),
          });

          newPage.drawText(label, {
            x: tableStartX + 5,
            y: currentY - rowHeight + 8,
            size: 10,
            font: avenirFont,
            color: rgb(0, 0, 0),
          });

          newPage.drawText(value, {
            x: tableStartX + colWidths[0] + 5,
            y: currentY - rowHeight + 8,
            size: 10,
            font: avenirFont,
            color: rgb(0, 0, 0),
          });

          currentY -= rowHeight;
        });

        currentY -= 40;

        // Generate Signature
        const signaturePreview = document.getElementById("signature-preview");
        const signatureCanvas = document.createElement("canvas");
        signatureCanvas.width = 250;
        signatureCanvas.height = 50;

        const ctx = signatureCanvas.getContext("2d");
        ctx.font = "16px Pacifico, cursive"; // Adjust as needed
        ctx.fillStyle = "#000";
        ctx.fillText(signaturePreview.textContent, 10, 30);

        const signatureImage = signatureCanvas.toDataURL("image/png");
        const signatureImageBytes = await fetch(signatureImage).then((res) =>
          res.arrayBuffer()
        );

        const signatureImageEmbedded = await pdfDoc.embedPng(
          signatureImageBytes
        );

        newPage.drawImage(signatureImageEmbedded, {
          x: tableStartX,
          y: currentY - 50,
          width: 250,
          height: 50,
        });

        // Save the updated PDF
        const updatedPdfBytes = await pdfDoc.save();

        // Download PDF
        const blob = new Blob([updatedPdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Signed_EOI.pdf";
        link.click();
      }

      // Add event listeners
      document
        .getElementById("eoi-form")
        .addEventListener("submit", handleSubmit);
      document
        .getElementById("signatureName")
        .addEventListener("input", generateSignature);
    </script>
  </body>
</html>
